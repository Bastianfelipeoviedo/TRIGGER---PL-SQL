
--INSTRUCCION 1.A
CREATE OR REPLACE TRIGGER TRG_INS_COMISION
AFTER INSERT ON BOLETA
FOR EACH ROW 
DECLARE
V_BOLETA_NUMERO VARCHAR2(15);
V_BOLETA_FECHA DATE;
V_BOLETA_MONTO NUMBER(15);
V_BOLETA_RUTC VARCHAR2(15);
V_BOLETA_RUTE VARCHAR2(15);
BEGIN
    V_BOLETA_NUMERO   := :NEW.NRO_BOLETA;
    V_BOLETA_FECHA    := :NEW.FECHA_BOLETA; 
    V_BOLETA_MONTO    := :NEW.MONTO_BOLETA;
    V_BOLETA_RUTC     := :NEW.RUT_CLI;
    V_BOLETA_RUTE     := :NEW.RUT_EMP;
    
    IF INSERTING THEN
        INSERT INTO COMISION_BOLETA VALUES (
        V_BOLETA_NUMERO, TO_CHAR(ROUND(V_BOLETA_MONTO * 0.07))); 
    END IF;
END;

--HACE LO QUE PIDE LA INSTRUCCION 1.D.1
INSERT INTO BOLETA VALUES(86, sysdate, 459990, '13029285-9','11213221-0');

--MUESTRA TODOS LOS NRO BOLETA, EL MONTO Y LA COMISION ASIGNADA
SELECT * FROM BOLETA BOL JOIN COMISION_BOLETA COB ON BOL.NRO_BOLETA = COB.NRO_BOLETA;

--- FIN PROCESO DE TRIGGER INSERT

-- INSTRUCCION 1.B 
CREATE OR REPLACE TRIGGER TRG_UPD_COMISION
AFTER UPDATE ON BOLETA
FOR EACH ROW DECLARE
V_BOLETA_NUMERO_N   VARCHAR2(15);
V_BOLETA_MONTO_N    NUMBER(15);
V_BOLETA_NUMERO_O   VARCHAR2(15);
V_BOLETA_MONTO_O    NUMBER(15);

BEGIN
    V_BOLETA_NUMERO_N   := :NEW.NRO_BOLETA;
    V_BOLETA_MONTO_N    := :NEW.MONTO_BOLETA;
    V_BOLETA_NUMERO_O   := :OLD.NRO_BOLETA;
    V_BOLETA_MONTO_O    := :OLD.MONTO_BOLETA;
    
    IF UPDATING THEN
        IF V_BOLETA_MONTO_O < V_BOLETA_MONTO_N THEN
        UPDATE COMISION_BOLETA SET MONTO_COMISION = TO_CHAR(ROUND(V_BOLETA_MONTO_O * 0.07))
        WHERE NRO_BOLETA = V_BOLETA_NUMERO_O;
        
        ELSIF V_BOLETA_MONTO_O > V_BOLETA_MONTO_N THEN
        UPDATE COMISION_BOLETA SET MONTO_COMISION = MONTO_COMISION
        WHERE NRO_BOLETA = V_BOLETA_NUMERO_O;
        
        END IF;
    END IF;
END;

-- INSTRUCCION 1.D.3
UPDATE BOLETA SET MONTO_BOLETA = 10990 WHERE NRO_BOLETA = 70;
--INSTRUCCION 1.D.2
UPDATE BOLETA SET MONTO_BOLETA = 99990 WHERE NRO_BOLETA = 80;

--MUESTRA LOS MONTOS FINALES DE BOLETA Y COMISION LUEGO DE HABER APICADO EL TRIGGER
SELECT * FROM BOLETA BOL JOIN COMISION_BOLETA COB ON BOL.NRO_BOLETA = COB.NRO_BOLETA
WHERE COB.NRO_BOLETA = 70 OR COB.NRO_BOLETA = 80 OR COB.NRO_BOLETA = 86;

--- FIN PROCESO DE TRIGGER UPDATE

-- LA INSTRUCCION 1.C
CREATE OR REPLACE TRIGGER TRG_DEL_COMISION
AFTER DELETE ON BOLETA
FOR EACH ROW 
DECLARE
V_BOLETA_NUMERO VARCHAR2(15);
V_BOLETA_FECHA DATE;
V_BOLETA_MONTO NUMBER(15);
V_BOLETA_RUTC VARCHAR2(15);
V_BOLETA_RUTE VARCHAR2(15);
BEGIN
    V_BOLETA_NUMERO   := :OLD.NRO_BOLETA;
    V_BOLETA_FECHA    := :OLD.FECHA_BOLETA; 
    V_BOLETA_MONTO    := :OLD.MONTO_BOLETA;
    V_BOLETA_RUTC     := :OLD.RUT_CLI;
    V_BOLETA_RUTE     := :OLD.RUT_EMP;
    
    IF DELETING THEN
        DELETE COMISION_BOLETA WHERE NRO_BOLETA = V_BOLETA_NUMERO ;
    END IF;
END;

-- 1.D.4
DELETE FROM BOLETA WHERE NRO_BOLETA = 20;
--- FIN PROCESO DE TRIGGER DELETE 
--- INSTRUCCION 1.E
SELECT * FROM BOLETA BOL JOIN COMISION_BOLETA COB ON BOL.NRO_BOLETA = COB.NRO_BOLETA
WHERE COB.NRO_BOLETA = 70 OR COB.NRO_BOLETA = 80 OR COB.NRO_BOLETA = 86;